import os
import PyPDF4
import pytesseract
import warnings
from pdf2image import convert_from_path
from PyPDF4.utils import PdfReadWarning

pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

warnings.filterwarnings('ignore', category=PdfReadWarning)

def is_searchable(pdf_path):
    with open(pdf_path, 'rb') as fr:
        reader = PyPDF4.PdfFileReader(fr)
        try:
            if reader.getPage(0).extractText():
                return True
        except:
            pass
    return False

def ocr_pdf(pdf_path):
    output_filename = os.path.splitext(pdf_path)[0] + '_OCR.txt'  # Change the extension to .txt
    images = convert_from_path(pdf_path)
    
    result = []
    for image in images:
        text = pytesseract.image_to_string(image)
        result.append(text)
    
    with open(output_filename, 'w', encoding='utf-8') as outfile:
        for line in result:
            outfile.write(line)
    
    print(f"OCR TXT {os.path.basename(pdf_path)} generated successfully.")

def main():
    input_folder = r'C:\python\autoindex\documents'
    pdf_files = [f for f in os.listdir(input_folder) if f.endswith('.pdf') and not f.endswith('_OCR.pdf')]
    
    for file in pdf_files:
        pdf_path = os.path.join(input_folder, file)
        try:
            if not is_searchable(pdf_path):
                ocr_pdf(pdf_path)
        except PyPDF4.utils.PdfReadError:
            print(f"Warning: Could not read the malformed PDF file: {os.path.basename(pdf_path)}")

if __name__ == '__main__':
    main()